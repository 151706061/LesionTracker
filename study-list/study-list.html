
<!--Polymer defined elements-->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/core-pages/core-pages.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/polymer-date-picker/polymer-date-picker.html">


<!-- Cornerstone viewport custom elements -->
<link rel="import" href="../lesion-location-dialog/lesion-location-dialog.html">
<link rel="import" href="../lesion-table/lesion-table.html">
<link rel="import" href="../hiding-panel/hiding-panel.html">
<link rel="import" href="../cornerstone-viewport/cornerstone-viewport.html" id="cornerstone-viewport">

<polymer-element name="study-list">
    <template>
        <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.css">
        <link rel="stylesheet" href="study-list.css">

        <paper-tabs id="paperTabs" selected="{{selected}}" nobar="true" noink="true">
            <paper-tab id="tabStudyList">Study List</paper-tab>
        </paper-tabs>

        <core-pages id="corePages" selected="{{selected}}">
            <div id="contentStudyList">


                <!--Search Panel-->
                <div class="panel panel-default">
                    <div class="panel-heading" style="background-color: #337ab7; color: white; font-weight: 500; font-size: 20px; line-height: 20px; box-shadow: 2px 2px 2px #888888;">Search</div>
                    <div class="panel-body">
                        <div style="padding: 10px;">
                            <div class="row">
                                <div class="col-lg-8 col-md-8 col-xs-12">
                                    <div class="row">
                                        <div class="col-lg-3 col-md-3 col-xs-10">
                                            <div class="form-group">
                                                <label for="patientId">Patient ID</label>
                                                <input type="text" class="form-control" id="patientId" placeholder="Patient ID">
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-3 col-xs-10">
                                            <div class="form-group">
                                                <label for="patientName">Name</label>
                                                <input type="text" class="form-control" id="patientName" placeholder="Name">
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-3 col-xs-10">
                                            <div class="form-group">
                                                <label for="patientAccessionNum">Accession #</label>
                                                <input type="text" class="form-control" id="patientAccessionNum" placeholder="Accession #">
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-3 col-xs-10">
                                            <div class="form-group">
                                                <label for="studyDescription">Study Description</label>
                                                <input type="text" class="form-control" id="studyDescription" placeholder="Study Description">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-lg-3 col-md-3 col-xs-10">
                                            <!--Add calendar ui-->
                                            <div class="form-group">
                                                <label for="studyDateFrom">Study Date(from)</label>
                                                <p><paper-checkbox id="checkFrom" class="dateEnableCheckbox"></paper-checkbox><input id="triggerDateFrom"  value="{{selectedDateFrom}}"  on-click="{{toggleFrom}}" class="date form-control dateInput"></p>
                                                <polymer-date-picker id="studyDateFrom"  selectedDate="{{selectedDateFrom}}" relatedTarget="{{$.triggerDateFrom}}" opened="false"></polymer-date-picker>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-3 col-xs-10">
                                            <div class="form-group">
                                                <label for="studyDateTo">Study Date(to)</label>
                                                <p><paper-checkbox id="checkTo" class="dateEnableCheckbox"></paper-checkbox><input id="triggerDateTo" value="{{selectedDateTo}}"  on-click="{{toggleTo}}" class="date form-control dateInput"></p>
                                                <polymer-date-picker id="studyDateTo"  selectedDate="{{selectedDateTo}}" relatedTarget="{{$.triggerDateTo}}" opened="false"></polymer-date-picker>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-3 col-xs-10">
                                            <div class="form-group">
                                                <label for="referringPhysician">Referring Physician</label>
                                                <input type="text" class="form-control" id="referringPhysician" placeholder="Referring Physician">
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-3 col-xs-10">
                                            <div class="form-group">
                                                <label for="modality">Modality</label>
                                                <input type="text" class="form-control" id="modality" placeholder="Modality">
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-4 col-md-4 col-xs-12">
                                    <div class="row" style="margin-top: 25px;margin-bottom: 25px;">
                                        <div class="col-lg-4 col-md-6 col-xs-6">
                                            <button class="btn btn-primary" style="width: 100%;" on-tap="{{search}}">Search</button>
                                        </div>
                                        <div class="col-lg-4 col-md-6 col-xs-6">
                                            <button class="btn btn-primary" style="width: 100%;" on-tap="{{today}}">Today</button>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-4 col-md-6 col-xs-6">
                                            <button class="btn btn-primary" style="width: 100%;" on-tap="{{clearStudyList}}">Clear</button>
                                        </div>
                                        <div class="col-lg-4 col-md-6 col-xs-6">
                                            <button class="btn btn-primary" style="width: 100%;" on-tap="{{sevenDays}}">Last 7 Days</button>
                                        </div>
                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!--Search panel ends-->
                <table class="tblStudyList">
                    <thead>
                    <tr>
                        <th>Patient Name</th>
                        <th>Patient ID</th>
                        <th>Accession Number</th>
                        <th>Study Date</th>
                        <th>Modality</th>
                        <th>Study Description</th>
                        <th># Images</th>
                    </tr>
                    </thead>

                    <tbody id="tblStudyList"></tbody>
                </table>
            </div>


        </core-pages>
    </template>

    <script>
        (function() {
            //Study List object
            //TODO: studyList will be load dynamically, it is hard-coded for now
            var studyList = [
                {patientName: "MISTER^MR",patientID: "832040",accessionNum:"", studyDate: "20010108", modality: "MR", studyDescription: "BRAIN SELLA", imagesNumber: "17", studyData: "mrstudy.json", seriesList :[{seriesNumber:"1",seriesDescription:"3-PLANE LOC"},{seriesNumber:"2",seriesDescription:"SAG T-1"},{seriesNumber:"3",seriesDescription:"CPR T-1"},{seriesNumber:"4",seriesDescription:"COR FSE T2"},{seriesNumber:"5",seriesDescription:"COR FLAIR"},{seriesNumber:"6",seriesDescription:"AX FSE T2"},{seriesNumber:"7",seriesDescription:"COR T-1 POST GAD"},{seriesNumber:"8",seriesDescription:"SAG T-1 POST GAD"}]},
                {patientName: "MISTER^CT",patientID: "2178309",accessionNum:"", studyDate: "20010105", modality: "CT", studyDescription: "CHEST", imagesNumber: "111", studyData: "ctstudy.json", seriesList : [{seriesNumber: "2",seriesDescription:"HELICAL CHEST"},{seriesNumber: "1",seriesDescription:"SCOUT PA"},{seriesNumber: "1.1",seriesDescription:"SCOUT LAT"},{seriesNumber: "5",seriesDescription:"PATHOLOGY"}]},
                {patientName: "MISTER^CR",patientID: "9227465",accessionNum:"", studyDate: "20010109", modality: "CR", studyDescription: "pelvis", imagesNumber: "2", studyData: "crstudy.json",seriesList : [{seriesNumber: "1",seriesDescription:"Pelvis PA"},{seriesNumber: "1",seriesDescription:"PELVIS LAT"}]},
                {patientName: "MISTER^DX",patientID: "3524578",accessionNum:"", studyDate: "20010109", modality: "DX", studyDescription: "CHEST", imagesNumber: "2", studyData: "dxstudy.json",seriesList : [{seriesNumber: "28858",seriesDescription:"PA"},{seriesNumber: "28860",seriesDescription:"LAT"}]},
                {patientName: "MS^MG",patientID: "1346269",accessionNum:"", studyDate: "20010109", modality: "MG", studyDescription: "MAMMOGRAM", imagesNumber: "8", studyData: "mgstudy.json",seriesList : [{seriesNumber: "700",seriesDescription:"MAMMOGRAM"},{seriesNumber: "699",seriesDescription:"BILATERAL"}]},
                {patientName: "US Echo",patientID: "",accessionNum:"", studyDate: "20120418", modality: "US", studyDescription: "US Dopler", imagesNumber: "22", studyData: "usdopplerstudy.json",seriesList : [{seriesNumber: "1",seriesDescription:"Image #1"},{seriesNumber: "2",seriesDescription:"Image #2"},{seriesNumber: "3",seriesDescription:"Image #3"},{seriesNumber: "4",seriesDescription:"Image #4"},{seriesNumber: "5",seriesDescription:"Image #5"},{seriesNumber: "6",seriesDescription:"Image #6"},{seriesNumber: "7",seriesDescription:"Image #7"},{seriesNumber: "8",seriesDescription:"Image #8"},{seriesNumber: "9",seriesDescription:"Image #9"}]},
                {patientName: "Dermatology",patientID: "922746522",accessionNum:"", studyDate: "20010109", modality: "DERM", studyDescription: "Skin Rash", imagesNumber: "2", studyData: "dermatology.json",seriesList : [{seriesNumber: "28858",seriesDescription:"Back"}]},
                {patientName: "US JPEG",patientID: "123454321",accessionNum:"", studyDate: "20120418", modality: "US", studyDescription: "US FETAL SURVEY", imagesNumber: "22", studyData: "usjpeg.json",seriesList : [{seriesNumber: "1",seriesDescription:"Image #1"},{seriesNumber: "2",seriesDescription:"Image #2"},{seriesNumber: "3",seriesDescription:"Image #3"}]}
            ];

            Polymer("study-list", {
                //Selected index
                selected: 0,
                //Date picker variables
                dateFromOpened: false,
                dateToOpened: false,

                //Previous tabIndex when active tab is closed
                previous: 0,

                toggleFrom: function() {
                    this.$.studyDateFrom.toggle();
                    this.$.checkFrom.checked = true;

                },
                toggleTo: function() {
                    this.$.studyDateTo.toggle();
                    this.$.checkTo.checked = true;
                },

                ready: function() {

                    var self = this;

                    //TODO: This is for demo. study-list will be loaded from studyList.html
                    this.loadStudyList("study_list");

                    //Study List tab is clicked
                    $(this.shadowRoot.querySelectorAll("paper-tab")).on("click",function(e) {
                        self.previous = 0;
                        self.selected = 0;
                    });

                    //Open new tab when click study list item
                    $(this.shadowRoot.querySelector("#tblStudyList")).on("click", "tr", function(e) {
                        var rowId = $(this).attr("id");
                        var study = studyList[rowId];
                        addNewPaperTab(study);
                    });

                    //Add new tab
                    function addNewPaperTab(study) {
                        var tabName = study.patientName;
                        var paperTabs = self.$.paperTabs;
                        var corePages = self.$.corePages;

                        //Create new paper-tab
                        var newPaperTabEl = document.createElement('paper-tab');
                        var uuid = generateUUID();
                        var tabId = "tab"+uuid;
                        newPaperTabEl.setAttribute("id",tabId);
                        newPaperTabEl.innerHTML = tabName;
                        newPaperTabEl.onclick = function() { // Note this is a function
                            paperTabClicked(tabId);
                        };
                        paperTabs.appendChild(newPaperTabEl);

                        //Create close button
                        var btnClose = document.createElement('a');
                        btnClose.className = "close-thin";
                        btnClose.onclick = function() { // Note this is a function
                            removeTab(uuid);
                        };
                        newPaperTabEl.appendChild(btnClose);

                        //Create paper-tab content
                        var newPaperContent = document.createElement('div');
                        var contentId = "content"+uuid;
                        newPaperContent.setAttribute("id",contentId);
                        corePages.appendChild(newPaperContent);

                        //Find index of tab
                        var tabIndex = $(self.shadowRoot.querySelector("#"+tabId)).index();

                        //Create cornerstone-viewport
                        createViewport(contentId, tabIndex, study);
                    }

                    //Remove tab
                    function removeTab (uuid) {
                        var removedTabIndex = $(self.shadowRoot.querySelectorAll("#tab"+uuid)).index();
                        //Remove tab
                        $(self.shadowRoot.querySelector("#tab"+uuid)).remove();
                        //Remove Content
                        $(self.shadowRoot.querySelector("#content"+uuid)).remove();

                        //Activate previous selected tab after a tab is removed
                        if(removedTabIndex !== self.selected){
                            self.previous = self.selected - 1;
                        }else{
                            if(removedTabIndex < self.previous){
                                self.previous -= 1;
                            }else if(removedTabIndex === self.previous){
                                self.previous = 0;
                            }
                        }

                        //Activate Tab
                        activateTab(self.previous);

                    }

                    //Generate UUID to define unique paper-tabs
                    function generateUUID(){
                        var d = new Date().getTime();
                        var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                            var r = (d + Math.random()*16)%16 | 0;
                            d = Math.floor(d/16);
                            return (c=='x' ? r : (r&0x3|0x8)).toString(16);
                        });
                        return uuid;
                    }

                    //Clean Cookie
                    function cleanCookie () {
                        var c = document.cookie.split("; ");
                        for (i in c)
                            document.cookie =/^[^=]+/.exec(c[i])[0]+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT";
                    }

                    //Create viewport page
                    function createViewport (contentId, tabIndex, study) {
                        //Clean cookie for every tab opening
                        if(document.cookie)
                            cleanCookie();

                        //Set cookie and save study inside it to open in studyListIndex.html
                        document.cookie = JSON.stringify(study);

                        var viewportContent = '<iframe id="frameIndex" src="studyListIndex.html" frameborder="0"></iframe>';
                        $(self.shadowRoot.querySelector("#"+contentId)).append(viewportContent);

                        //Activate tab
                        activateTab(tabIndex);
                    }

                    //Activate added tab
                    function activateTab(tabIndex) {
                        self.selected = tabIndex;
                    }

                    //Tab clicked event
                    function paperTabClicked(tabId){
                        self.previous = self.selected;
                        var tabIndex = $(self.shadowRoot.querySelector("#"+tabId)).index();
                        if(tabIndex > 0)
                            self.selected = tabIndex;
                    }


                },

                //Load Study List: this function is called from studyList.html page
                loadStudyList: function (study_list) {
                    var tblStudyList = this.$.tblStudyList;
                    //Remove study list rows
                    $(tblStudyList).empty();
                    //TODO: Comment out list when load studyList object from server
                    //studyList = study_list;
                    //studyList.push({patientName: "MISTER^MR",patientID: "832040", studyDate: "20010108", modality: "MR", studyDescription: "BRAIN SELLA", imagesNumber: "17"},{patientName: "MISTER^MR2",patientID: "832040-2", studyDate: "20010108", modality: "MR", studyDescription: "BRAIN SELLA-2-2", imagesNumber: "17"});
                    this.loadStudyListTable(studyList);
                },

                loadStudyListTable: function (list) {
                    var tblStudyList = this.$.tblStudyList;
                    //Remove study list rows
                    $(tblStudyList).empty();
                    if(list.length){
                        for(var i=0;i < list.length; i++){
                            var study = list[i];
                            if(study.patientID !== ""){
                                var rowContent = "<tr id="+i+"><td>"+study.patientName+"</td><td>"+study.patientID+"</td><td>"+study.accessionNum+"</td><td>"+study.studyDate+"</td><td>"+study.modality+"</td><td>"+study.studyDescription+"</td><td>"+study.imagesNumber+"</td></tr>";
                                $(tblStudyList).append(rowContent);
                            }
                        }
                    }
                },

                search: function(){
                    var patientId = this.$.patientId.value;
                    var patientName = this.$.patientName.value;
                    var accessionNum = this.$.patientAccessionNum.value;
                    var studyDescription = this.$.studyDescription.value;
                    var studyDateFrom = this.$.triggerDateFrom.value;
                    var studyDateTo = this.$.triggerDateTo.value;
                    var modality = this.$.modality.value;

                    var self = this;

                    //Filter studyList and get mathced records
                    var filteredList = studyList.filter(function(obj){

                        if(isIndexOf(obj.patientID, patientId)
                            && isIndexOf(obj.patientName, patientName)
                            && isIndexOf(obj.accessionNum, accessionNum)
                            && isIndexOf(obj.studyDescription.toLowerCase(), studyDescription.toLowerCase())
                            && isIndexOf(obj.modality.toLowerCase(), modality.toLowerCase())
                            && (self.convertStringToDate(obj.studyDate) >= new Date(studyDateFrom) || !self.$.checkFrom.checked)
                            && (self.convertStringToDate(obj.studyDate) <= new Date(studyDateTo) || !self.$.checkTo.checked)) {
                            return true;
                        }

                        return false;

                    });

                    function isIndexOf (mainVal, searchVal) {
                        if(mainVal === undefined || mainVal === '' || mainVal.indexOf(searchVal) > -1){
                            return true;
                        }

                        return false;
                    }

                    //Add filteredList to table
                    this.loadStudyListTable(filteredList);
                    console.log(filteredList);
                },

                //Get today's study list
                today: function () {
                    var self = this;
                    //Filter studyList and get mathced records
                    var filteredList = studyList.filter(function(obj){

                        if(self.convertStringToDate(obj.studyDate) === new Date()) {
                            return true;
                        }

                        return false;

                    });

                    //Add filteredList to table
                    this.loadStudyListTable(filteredList);
                    console.log(filteredList);
                },

                //Get last 7 days study list
                sevenDays: function() {

                    var sevenDayBefore =  new Date(new Date().setDate(new Date().getDate()-7))
                    var self = this;
                    //Filter studyList and get mathced records
                    var filteredList = studyList.filter(function(obj){

                        if(self.convertStringToDate(obj.studyDate) >= sevenDayBefore) {
                            return true;
                        }

                        return false;

                    });

                    //Add filteredList to table
                    this.loadStudyListTable(filteredList);
                    console.log(filteredList);
                },

                //Clear study list table, remove all filter
                clearStudyList: function () {

                    //Clear all input elements
                    $(this.$.patientId).val("");
                    $(this.$.patientName).val("");
                    $(this.$.patientAccessionNum).val("");
                    $(this.$.studyDescription).val("");
                    $(this.$.modality).val("");
                    $(this.$.triggerDateFrom).val(this.todayDate());
                    $(this.$.triggerDateTo).val(this.todayDate());
                    this.$.checkFrom.checked = false;
                    this.$.checkTo.checked = false;

                    //Return to initial state of table
                    this.loadStudyListTable(studyList);
                },

                convertStringToDate: function (dateStr) {
                    var y = dateStr.substring(0,4);
                    var m = dateStr.substring(4,6);
                    var d = dateStr.substring(6,8);
                    var newDateStr = y+"-"+m+"-"+d;

                    var date_ = new Date(newDateStr);

                    return date_;
                },

                todayDate: function() {
                    var today = new Date();
                    var dd = today.getDate();
                    var mm = today.getMonth()+1; //January is 0!

                    var yyyy = today.getFullYear();
                    if(dd<10){
                        dd='0'+dd
                    }
                    if(mm<10){
                        mm='0'+mm
                    }
                    var today = yyyy+"-"+mm+"-"+dd;
                    return today;
                }


            });

        }) ();

    </script>
</polymer-element>